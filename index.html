<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zuber - Ultimate Secure Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        /* --- RESET & GLOBAL --- */
        :root {
            --bg-color: #d1d7db;
            --sidebar-bg: #ffffff;
            --header-bg: #f0f2f5;
            --chat-bg: #efeae2;
            --primary-green: #00a884;
            --incoming-bubble: #ffffff;
            --outgoing-bubble: #d9fdd3;
            --text-primary: #111b21;
            --text-secondary: #667781;
            --blue-tick: #34b7f1;
            --border-color: #e9edef;
            --shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif; }
        
        body {
            background-color: var(--bg-color); height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden;
        }

        /* --- APP CONTAINER --- */
        #app-wrapper {
            width: 100%; height: 100%; max-width: 1600px; background: #fff; display: flex;
            position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        /* --- SCREEN MANAGEMENT --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; background: #fff; z-index: 10;
        }
        .screen.active { display: flex; z-index: 20; }

        /* --- 1. SPLASH SCREEN --- */
        #splash-screen {
            background: #fff; justify-content: center; align-items: center; z-index: 100;
        }
        .splash-logo { font-size: 3rem; font-weight: 700; letter-spacing: -1px; color: var(--primary-green); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .loader { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-green); border-radius: 50%; animation: spin 1s linear infinite; margin-top: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- 2. AUTH SCREEN --- */
        #auth-screen {
            background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%); justify-content: center; align-items: center;
        }
        .auth-card {
            background: #fff; width: 100%; max-width: 400px; padding: 40px;
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;
        }
        .auth-card h1 { color: var(--primary-green); margin-bottom: 10px; }
        
        .input-group { text-align: left; margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.85rem; color: #666; margin-bottom: 5px; font-weight: 600; }
        .std-input {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;
            transition: 0.3s; outline: none;
        }
        .std-input:focus { border-color: var(--primary-green); box-shadow: 0 0 0 2px rgba(0,168,132,0.1); }

        .primary-btn {
            width: 100%; padding: 12px; background: var(--primary-green); color: white; border: none;
            border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .primary-btn:hover { background: #008f72; }
        .link-btn { color: var(--primary-green); font-weight: 600; cursor: pointer; margin-top: 15px; display: block; }

        /* --- 3. SETUP SCREEN --- */
        #setup-screen { background: #f2f2f2; justify-content: center; align-items: center; }
        
        /* --- 4. ADMIN PANEL --- */
        #admin-panel {
            background: #f2f2f7; width: 100%; height: 100%; padding: 20px; overflow-y: auto;
        }
        .admin-header { text-align: center; margin-bottom: 30px; padding: 20px; background: #fff; border-radius: 10px; }
        .req-card {
            background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid var(--primary-green);
        }
        .req-detail { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .req-img-preview { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ddd; }
        .action-row { display: flex; gap: 10px; }
        .btn-accept { flex: 1; background: var(--primary-green); color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; }
        .btn-reject { flex: 1; background: #dc3545; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; }

        /* --- 5. MAIN APP LAYOUT --- */
        /* Sidebar */
        .sidebar {
            width: 30%; min-width: 320px; max-width: 450px; border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; background: var(--sidebar-bg);
        }
        .sidebar-header {
            height: 60px; background-color: var(--header-bg); padding: 10px 16px; display: flex;
            align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color);
        }
        .my-profile { display: flex; align-items: center; cursor: pointer; }
        .profile-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .profile-info { margin-left: 10px; }
        .profile-name { font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; }
        .blue-tick-icon { color: var(--blue-tick); font-size: 1rem; margin-left: 4px; display: none; }
        
        .add-contact-section { padding: 10px 15px; background: #f0f2f5; display: none; border-bottom: 1px solid var(--border-color); }
        .search-box { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 20px; outline: none; background: #fff; }

        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item {
            display: flex; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f2f5;
            transition: background 0.2s;
        }
        .chat-item:hover { background-color: #f5f6f6; }
        .chat-item img { width: 49px; height: 49px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
        .chat-meta { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .chat-top-row { display: flex; justify-content: space-between; }
        .chat-user { font-size: 1.05rem; color: var(--text-primary); font-weight: 500; display: flex; align-items: center; }
        .chat-time { font-size: 0.75rem; color: var(--text-secondary); }
        .chat-preview { font-size: 0.85rem; color: var(--text-secondary); margin-top: 3px; }

        /* Chat Area */
        .chat-area {
            flex: 1; display: flex; flex-direction: column;
            background-color: var(--chat-bg);
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            background-size: contain; background-repeat: repeat;
            position: relative;
        }
        
        .chat-header {
            height: 60px; background-color: var(--header-bg); padding: 10px 16px; display: flex;
            align-items: center; border-bottom: 1px solid var(--border-color); z-index: 5;
        }
        .back-btn { display: none; margin-right: 15px; font-size: 1.5rem; cursor: pointer; color: #54656f; }
        .chat-header-info { display: flex; align-items: center; }
        .header-name { font-weight: 500; color: #111b21; }
        
        .messages-scroll { flex: 1; padding: 20px 60px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
        
        .message { max-width: 65%; padding: 6px 7px 8px 9px; border-radius: 7.5px; font-size: 0.9rem; position: relative; word-wrap: break-word; }
        .message.incoming { align-self: flex-start; background: var(--incoming-bubble); border-top-left-radius: 0; box-shadow: 0 1px 0.5px rgba(11,20,26,0.13); }
        .message.outgoing { align-self: flex-end; background: var(--outgoing-bubble); border-top-right-radius: 0; box-shadow: 0 1px 0.5px rgba(11,20,26,0.13); }
        .msg-meta { display: flex; justify-content: flex-end; align-items: center; margin-top: 2px; margin-left: 10px; float: right; gap: 4px; font-size: 0.65rem; color: #8696a0; }

        .input-area {
            min-height: 62px; background: var(--header-bg); padding: 5px 16px; display: flex;
            align-items: center; gap: 15px; z-index: 5;
        }
        .msg-input { flex: 1; background: #fff; border-radius: 8px; padding: 9px 12px; border: none; outline: none; }
        .send-icon { color: #54656f; font-size: 1.5rem; cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.2s; }
        .send-icon.ready { color: var(--primary-green); opacity: 1; pointer-events: auto; }

        /* Empty State */
        .empty-state {
            flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #f0f2f5; border-bottom: 6px solid #25d366; text-align: center; color: #41525d;
        }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; justify-content: center; align-items: center;
        }
        .modal-box {
            background: #fff; width: 90%; max-width: 450px; border-radius: 12px; padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar { width: 100%; z-index: 20; position: absolute; height: 100%; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
            .chat-area { width: 100%; position: absolute; height: 100%; z-index: 30; }
            .sidebar.slide-out { transform: translateX(-100%); }
            .chat-area.slide-in { transform: translateX(0); }
            .chat-area.slide-out { transform: translateX(100%); }
            .back-btn { display: block; }
            .messages-scroll { padding: 10px 15px; }
        }
    </style>
</head>
<body>

<div id="app-wrapper">

    <!-- 1. SPLASH -->
    <div id="splash-screen" class="screen active">
        <div class="splash-logo">ZUBER</div>
        <div class="loader"></div>
        <p style="margin-top: 15px; color: #888; font-size: 0.9rem;">Loading Secure Environment...</p>
    </div>

    <!-- 2. AUTHENTICATION -->
    <div id="auth-screen" class="screen">
        <div class="auth-card">
            <h1>Zuber Chat</h1>
            <p style="color: #666; margin-bottom: 20px;">The most reliable way to chat.</p>
            
            <div id="login-form">
                <div class="input-group">
                    <label>Email Address</label>
                    <input type="email" id="l-email" class="std-input" placeholder="name@example.com">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="l-pass" class="std-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button class="primary-btn" id="btn-login">LOG IN</button>
                <a class="link-btn" id="btn-to-signup">Create new account</a>
            </div>

            <div id="signup-form" style="display:none;">
                <div class="input-group">
                    <label>Email Address</label>
                    <input type="email" id="s-email" class="std-input" placeholder="name@example.com">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="s-pass" class="std-input" placeholder="Create password">
                </div>
                <button class="primary-btn" id="btn-signup">SIGN UP</button>
                <a class="link-btn" id="btn-to-login">Already have account?</a>
            </div>
        </div>
    </div>

    <!-- 3. USERNAME SETUP -->
    <div id="setup-screen" class="screen">
        <div class="auth-card">
            <h2>Setup Profile</h2>
            <p style="color: #666; margin-bottom: 15px;">Choose a unique username to start.</p>
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="setup-username" class="std-input" placeholder="e.g. rahul123">
            </div>
            <button class="primary-btn" id="btn-setup-save">START CHATTING</button>
        </div>
    </div>

    <!-- 4. ADMIN PANEL (Username: zuber) -->
    <div id="admin-panel" class="screen">
        <div class="admin-header">
            <h2>Admin Dashboard</h2>
            <p>Manage Verification Requests</p>
            <button class="primary-btn" id="btn-admin-logout" style="width: 150px; margin-top: 10px; background: #333;">LOGOUT</button>
        </div>
        <div id="admin-requests-list">
            <!-- Requests injected here -->
            <p style="text-align:center; color:#999;">Loading requests...</p>
        </div>
    </div>

    <!-- 5. MAIN CHAT APPLICATION -->
    <div id="main-app" class="screen">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar-el">
            <div class="sidebar-header">
                <div class="my-profile" id="my-profile-trigger">
                    <img src="" class="profile-avatar" id="sidebar-avatar">
                    <div class="profile-info">
                        <div class="profile-name" id="sidebar-username">
                            User <i class="ri-verified-badge-fill blue-tick-icon" id="sidebar-tick"></i>
                        </div>
                        <div style="font-size: 0.75rem; color: #54656f;">Online</div>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; color: #54656f;">
                    <i class="ri-user-add-line" style="font-size: 1.2rem; cursor: pointer;" id="btn-show-add"></i>
                    <i class="ri-logout-box-r-line" style="font-size: 1.2rem; cursor: pointer;" id="btn-logout"></i>
                </div>
            </div>
            
            <div class="add-contact-section" id="add-contact-box">
                <input type="text" class="search-box" id="contact-search" placeholder="Search exact username...">
            </div>

            <div class="chat-list" id="chat-list-el">
                <!-- Chat Items -->
            </div>
        </aside>

        <!-- Chat Area -->
        <main class="chat-area slide-out" id="chat-area-el">
            <div class="empty-state" id="chat-empty">
                <div style="font-size: 4rem; color: #ccc; margin-bottom: 20px;"><i class="ri-whatsapp-line"></i></div>
                <h2>Zuber Web</h2>
                <p style="color: #666;">Send and receive messages securely.</p>
            </div>

            <div style="display: none; flex-direction: column; height: 100%;" id="chat-active">
                <header class="chat-header">
                    <i class="ri-arrow-left-line back-btn" id="btn-chat-back"></i>
                    <img src="" class="profile-avatar" id="active-avatar" style="margin-right: 10px; width: 35px; height: 35px;">
                    <div class="chat-header-info">
                        <div class="header-name" id="active-name">User</div>
                        <div style="font-size: 0.75rem; color: #54656f;">Online</div>
                    </div>
                </header>

                <div class="messages-scroll" id="msg-container">
                    <!-- Messages -->
                </div>

                <footer class="input-area">
                    <input type="text" class="msg-input" id="msg-input" placeholder="Type a message">
                    <i class="ri-send-plane-fill send-icon" id="btn-send-msg"></i>
                </footer>
            </div>
        </main>
    </div>

</div>

<!-- Verification Modal -->
<div class="modal-overlay" id="verify-modal">
    <div class="modal-box">
        <h2 style="margin-bottom: 15px;">Request Blue Tick</h2>
        <div class="input-group">
            <label>Username (Read Only)</label>
            <input type="text" id="v-username" class="std-input" readonly style="background: #f9f9f9;">
        </div>
        <div class="input-group">
            <label>Real Full Name</label>
            <input type="text" id="v-name" class="std-input" placeholder="As on ID">
        </div>
        <div class="input-group">
            <label>Profession</label>
            <input type="text" id="v-prof" class="std-input" placeholder="e.g. Doctor">
        </div>
        <div class="input-group">
            <label>Aadhar / ID Card</label>
            <div style="border: 1px dashed #ccc; padding: 10px; text-align: center; cursor: pointer; border-radius: 6px;" onclick="document.getElementById('v-file').click()">
                <i class="ri-upload-cloud-line"></i> Click to Upload Image
                <input type="file" id="v-file" hidden accept="image/*">
            </div>
        </div>
        <button class="primary-btn" id="btn-submit-verify">SUBMIT REQUEST</button>
        <button class="primary-btn" id="btn-close-verify" style="background: #eee; color: #333; margin-top: 10px;">CANCEL</button>
    </div>
</div>

<script type="module">
    // ==========================================
    // 1. INITIALIZATION & CONFIG
    // ==========================================
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, onValue, push, get, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyChKPlzj9uVm3KBi4iPOz8xQHtC6v0Lt4E",
        authDomain: "krp-bank.firebaseapp.com",
        databaseURL: "https://krp-bank-default-rtdb.firebaseio.com",
        projectId: "krp-bank",
        storageBucket: "krp-bank.firebasestorage.app",
        messagingSenderId: "911407082396",
        appId: "1:911407082396:web:c5af104a844e2697797659",
        measurementId: "G-R0J2TLLC3T"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // ==========================================
    // 2. STATE MANAGEMENT
    // ==========================================
    
    let currentUser = null;
    let currentUsername = null;
    let isAdmin = false;
    let currentChatId = null;

    // DOM Elements Cache
    const screens = {
        splash: document.getElementById('splash-screen'),
        auth: document.getElementById('auth-screen'),
        setup: document.getElementById('setup-screen'),
        admin: document.getElementById('admin-panel'),
        main: document.getElementById('main-app')
    };

    const modals = {
        verify: document.getElementById('verify-modal')
    };

    // Utility: Switch Screen
    function showScreen(name) {
        Object.values(screens).forEach(el => el.classList.remove('active'));
        if(screens[name]) screens[name].classList.add('active');
    }

    // Global Error Catcher
    window.onerror = function(message, source, lineno, colno, error) {
        console.error("CRASH DETECTED:", error);
        // alert("An unexpected error occurred. Check console.");
    };

    // ==========================================
    // 3. AUTHENTICATION LOGIC
    // ==========================================

    setTimeout(() => {
        // Splash duration
        showScreen('auth'); 
    }, 2000);

    document.getElementById('btn-to-signup').onclick = () => {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('signup-form').style.display = 'block';
    };
    
    document.getElementById('btn-to-login').onclick = () => {
        document.getElementById('signup-form').style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
    };

    document.getElementById('btn-login').onclick = async () => {
        const email = document.getElementById('l-email').value;
        const pass = document.getElementById('l-pass').value;
        if(!email || !pass) return alert("Please fill all fields");
        try {
            await signInWithEmailAndPassword(auth, email, pass);
            alert("Login Successful!");
        } catch (err) {
            alert("Login Failed: " + err.message);
        }
    };

    document.getElementById('btn-signup').onclick = async () => {
        const email = document.getElementById('s-email').value;
        const pass = document.getElementById('s-pass').value;
        if(!email || !pass) return alert("Please fill all fields");
        try {
            await createUserWithEmailAndPassword(auth, email, pass);
            alert("Account Created Successfully!");
        } catch (err) {
            alert("Signup Failed: " + err.message);
        }
    };

    document.getElementById('btn-logout').onclick = () => handleLogout();
    document.getElementById('btn-admin-logout').onclick = () => handleLogout();

    function handleLogout() {
        signOut(auth).then(() => {
            window.location.reload();
        }).catch(err => alert(err.message));
    }

    // ==========================================
    // 4. USERNAME & INITIALIZATION
    // ==========================================

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            fetchUserDetails(user.uid);
        } else {
            showScreen('auth');
        }
    });

    async function fetchUserDetails(uid) {
        try {
            const snapshot = await get(ref(db, 'users/' + uid));
            if (snapshot.exists()) {
                const data = snapshot.val();
                currentUsername = data.username;
                isAdmin = (currentUsername === 'zuber');
                
                if (isAdmin) {
                    initAdminPanel();
                } else {
                    initUserApp(data);
                }
            } else {
                showScreen('setup');
            }
        } catch (err) {
            console.error(err);
            showScreen('auth'); // Fallback
        }
    }

    document.getElementById('btn-setup-save').onclick = async () => {
        const uName = document.getElementById('setup-username').value.trim().toLowerCase();
        if (uName.length < 3) return alert("Username must be at least 3 characters");

        try {
            // Check uniqueness
            const snap = await get(ref(db, 'usernames/' + uName));
            if (snap.exists()) return alert("Username already taken!");

            // Save data
            await set(ref(db, 'usernames/' + uName), currentUser.uid);
            await set(ref(db, 'users/' + currentUser.uid), {
                username: uName,
                email: currentUser.email,
                verified: false,
                uid: currentUser.uid
            });
            
            currentUsername = uName;
            fetchUserDetails(currentUser.uid); // Re-init
        } catch (err) {
            alert("Error saving username: " + err.message);
        }
    };

    // ==========================================
    // 5. ADMIN PANEL LOGIC
    // ==========================================

    function initAdminPanel() {
        showScreen('admin');
        const list = document.getElementById('admin-requests-list');
        
        onValue(ref(db, 'requests'), (snapshot) => {
            list.innerHTML = "";
            if (!snapshot.exists()) {
                list.innerHTML = "<p style='text-align:center; padding:20px; color:#999;'>No pending requests.</p>";
                return;
            }

            snapshot.forEach((child) => {
                const r = child.val();
                const rUid = child.key;
                
                const card = document.createElement('div');
                card.className = 'req-card';
                card.innerHTML = `
                    <div class="req-detail"><strong>Username:</strong> ${r.username}</div>
                    <div class="req-detail"><strong>Real Name:</strong> ${r.realName}</div>
                    <div class="req-detail"><strong>Profession:</strong> ${r.profession}</div>
                    <img src="${r.docUrl}" class="req-img-preview">
                    <div class="action-row">
                        <button class="btn-accept" onclick="window.acceptReq('${rUid}', '${r.username}')">ACCEPT</button>
                        <button class="btn-reject" onclick="window.rejectReq('${rUid}')">REJECT</button>
                    </div>
                `;
                list.appendChild(card);
            });
        });
    }

    window.acceptReq = async (rUid, rName) => {
        if (!confirm("Accept " + rName + " as verified user?")) return;

        try {
            // 1. Verify User
            await update(ref(db, 'users/' + rUid), { verified: true });

            // 2. Send Congratulation Message
            const chatId = [currentUser.uid, rUid].sort().join('_');
            await push(ref(db, 'chats/' + chatId), {
                sender: currentUser.uid,
                text: `Congratulations! ðŸŽ‰ Your account is now verified (Blue Tick).`,
                timestamp: Date.now()
            });

            // 3. Remove Request
            await remove(ref(db, 'requests/' + rUid));
            alert("User Verified & Notified.");
        } catch (err) {
            alert("Action Failed: " + err.message);
        }
    };

    window.rejectReq = async (rUid) => {
        if (!confirm("Reject this request?")) return;
        try {
            await remove(ref(db, 'requests/' + rUid));
        } catch (err) {
            alert("Action Failed: " + err.message);
        }
    };

    // ==========================================
    // 6. USER APP LOGIC
    // ==========================================

    function initUserApp(data) {
        showScreen('main');
        
        // Update Sidebar
        document.getElementById('sidebar-avatar').src = `https://ui-avatars.com/api/?name=${data.username}&background=random`;
        document.getElementById('sidebar-username').innerHTML = `${data.username} <i class="ri-verified-badge-fill blue-tick-icon ${data.verified ? 'show' : ''}" style="display:${data.verified?'inline-block':'none'}"></i>`;

        // Verification Trigger
        document.getElementById('my-profile-trigger').onclick = () => {
            if (data.verified) {
                alert("You are already verified!");
            } else {
                modals.verify.style.display = 'flex';
                document.getElementById('v-username').value = currentUsername;
            }
        };

        loadContacts();
    }

    document.getElementById('btn-close-verify').onclick = () => modals.verify.style.display = 'none';

    // Submit Verification Request
    document.getElementById('btn-submit-verify').onclick = async () => {
        const name = document.getElementById('v-name').value;
        const prof = document.getElementById('v-prof').value;
        const file = document.getElementById('v-file').files[0];

        if (!name || !prof || !file) return alert("Please fill all fields and upload ID.");

        try {
            // Upload Image
            let imgUrl = "https://via.placeholder.com/150"; // Fallback
            try {
                const sRef = sRef(storage, 'verify_docs/' + currentUser.uid);
                await uploadBytes(sRef, file);
                imgUrl = await getDownloadURL(sRef);
            } catch (err) {
                console.warn("Upload failed, using placeholder.", err);
                alert("Note: Image upload failed (Check Storage Rules). Request sent with placeholder.");
            }

            // Send to Admin
            await set(ref(db, 'requests/' + currentUser.uid), {
                username: currentUsername,
                realName: name,
                profession: prof,
                docUrl: imgUrl,
                email: currentUser.email
            });

            modals.verify.style.display = 'none';
            alert("Request sent to Admin 'zuber'. Wait for approval.");
        } catch (err) {
            alert("Error: " + err.message);
        }
    };

    // --- CONTACTS & CHAT ---

    document.getElementById('btn-show-add').onclick = () => {
        const box = document.getElementById('add-contact-box');
        box.style.display = box.style.display === 'none' ? 'block' : 'none';
    };

    document.getElementById('contact-search').onkeypress = async (e) => {
        if (e.key === 'Enter') {
            const uName = document.getElementById('contact-search').value.trim().toLowerCase();
            if (!uName) return;

            try {
                const snap = await get(ref(db, 'usernames/' + uName));
                if (snap.exists()) {
                    const fid = snap.val();
                    if (fid === currentUser.uid) return alert("Cannot add yourself.");
                    
                    await set(ref(db, 'users/' + currentUser.uid + '/contacts/' + fid), {
                        username: uName, timestamp: Date.now()
                    });
                    document.getElementById('contact-search').value = '';
                    document.getElementById('add-contact-box').style.display = 'none';
                    alert("Contact added.");
                } else {
                    alert("User not found.");
                }
            } catch (err) {
                alert("Error: " + err.message);
            }
        }
    };

    function loadContacts() {
        const listEl = document.getElementById('chat-list-el');
        onValue(ref(db, 'users/' + currentUser.uid + '/contacts'), (snap) => {
            listEl.innerHTML = "";
            const contacts = [];
            snap.forEach(child => contacts.push({ uid: child.key, ...child.val() }));
            contacts.sort((a, b) => b.timestamp - a.timestamp);

            if (contacts.length === 0) {
                listEl.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>No contacts. Add one!</div>";
                return;
            }

            contacts.forEach(contact => {
                // Check verification status
                get(ref(db, 'users/' + contact.uid)).then(uSnap => {
                    if (!uSnap.exists()) return;
                    const userData = uSnap.val();
                    const tick = userData.verified ? '<i class="ri-verified-badge-fill" style="color:var(--blue-tick);"></i>' : '';

                    const div = document.createElement('div');
                    div.className = 'chat-item';
                    div.onclick = () => openChat(contact.uid, contact.username);
                    div.innerHTML = `
                        <img src="https://ui-avatars.com/api/?name=${contact.username}&background=random">
                        <div class="chat-meta">
                            <div class="chat-top-row">
                                <span class="chat-user">${contact.username} ${tick}</span>
                                <span class="chat-time"></span>
                            </div>
                            <div class="chat-preview">Tap to chat</div>
                        </div>
                    `;
                    listEl.appendChild(div);
                });
            });
        });
    }

    function openChat(uid, name) {
        currentChatId = [currentUser.uid, uid].sort().join('_');
        
        // UI Updates
        document.getElementById('chat-empty').style.display = 'none';
        document.getElementById('chat-active').style.display = 'flex';
        
        document.getElementById('active-name').innerText = name;
        document.getElementById('active-avatar').src = `https://ui-avatars.com/api/?name=${name}&background=random`;

        // Mobile Logic
        if (window.innerWidth <= 768) {
            document.getElementById('sidebar-el').classList.add('slide-out');
            document.getElementById('chat-area-el').classList.remove('slide-out');
            document.getElementById('chat-area-el').classList.add('slide-in');
        }

        loadMessages();
    }

    document.getElementById('btn-chat-back').onclick = () => {
        if (window.innerWidth <= 768) {
            document.getElementById('sidebar-el').classList.remove('slide-out');
            document.getElementById('chat-area-el').classList.remove('slide-in');
            document.getElementById('chat-area-el').classList.add('slide-out');
        }
        currentChatId = null;
    };

    function loadMessages() {
        onValue(ref(db, 'chats/' + currentChatId), (snap) => {
            const con = document.getElementById('msg-container');
            con.innerHTML = "";
            const msgs = [];
            snap.forEach(child => msgs.push(child.val()));
            msgs.sort((a, b) => a.timestamp - b.timestamp);

            msgs.forEach(msg => {
                const div = document.createElement('div');
                div.className = `message ${msg.sender === currentUser.uid ? 'outgoing' : 'incoming'}`;
                const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                div.innerHTML = `
                    ${msg.text}
                    <span class="msg-meta">${time}</span>
                `;
                con.appendChild(div);
            });
            con.scrollTop = con.scrollHeight;
        });
    }

    const inp = document.getElementById('msg-input');
    const btn = document.getElementById('btn-send-msg');

    inp.oninput = () => btn.classList.toggle('ready', inp.value.trim().length > 0);
    inp.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
    btn.onclick = sendMessage;

    function sendMessage() {
        const txt = inp.value.trim();
        if (!txt || !currentChatId) return;

        push(ref(db, 'chats/' + currentChatId), {
            sender: currentUser.uid,
            text: txt,
            timestamp: Date.now()
        });
        inp.value = "";
        btn.classList.remove('ready');
    }

</script>
</body>
</html>
