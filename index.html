<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zuber - Chat App</title>
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        /* --- CSS Reset & WhatsApp Theme --- */
        :root {
            --app-bg: #d1d7db;
            --sidebar-bg: #ffffff;
            --chat-bg: #efeae2;
            --primary-green: #00a884;
            --outgoing-bubble: #d9fdd3;
            --incoming-bubble: #ffffff;
            --text-primary: #111b21;
            --text-secondary: #667781;
            --border-color: #e9edef;
            --header-bg: #f0f2f5;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif; }
        
        body { background-color: var(--app-bg); height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }

        .app-container {
            width: 100%; height: 100%; max-width: 1600px; background: #fff; display: flex;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative;
        }

        /* --- Screens --- */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* --- Auth Screen --- */
        .auth-wrapper {
            flex: 1; display: flex; justify-content: center; align-items: center; background: #fff;
        }
        .auth-box {
            width: 350px; text-align: center; border: 1px solid #ddd; padding: 30px; border-radius: 10px;
        }
        .auth-box h2 { color: var(--primary-green); margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 0.85rem; margin-bottom: 5px; color: #666; }
        .input-group input {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; outline: none;
        }
        .btn-auth {
            width: 100%; padding: 10px; background: var(--primary-green); color: white; border: none;
            border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px;
        }
        .toggle-link { margin-top: 15px; font-size: 0.9rem; cursor: pointer; color: var(--primary-green); }

        /* --- Main App (Sidebar + Chat) --- */
        .sidebar {
            width: 30%; min-width: 300px; max-width: 450px; border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; background: var(--sidebar-bg);
        }
        
        /* Sidebar Header */
        .header {
            height: 60px; background-color: var(--header-bg); padding: 10px 16px; display: flex;
            align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color);
        }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; }
        .header-icons { display: flex; gap: 20px; color: #54656f; }
        .icon-btn { cursor: pointer; font-size: 1.2rem; color: inherit; background: none; border: none; }

        /* Add Contact Form */
        .add-contact-form {
            padding: 10px 15px; background: #fff; border-bottom: 1px solid #e9edef; display: none; /* Hidden by default */
        }
        .add-contact-form.active { display: block; }
        .add-contact-form input {
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; outline: none;
        }

        /* Chat List */
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item {
            display: flex; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f2f5;
        }
        .chat-item:hover { background-color: #f5f6f6; }
        .chat-item.active { background-color: #f0f2f5; }
        .chat-item img { width: 49px; height: 49px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
        .chat-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .chat-name { font-size: 1.05rem; color: var(--text-primary); }
        .chat-preview { font-size: 0.85rem; color: var(--text-secondary); margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Chat Area --- */
        .chat-area {
            flex: 1; display: flex; flex-direction: column;
            background-color: var(--chat-bg);
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            position: relative;
        }

        /* Chat Header */
        .chat-area-header {
            height: 60px; background: var(--header-bg); padding: 10px 16px; display: flex;
            align-items: center; border-bottom: 1px solid var(--border-color); z-index: 10;
        }
        .back-btn { display: none; margin-right: 10px; font-size: 1.5rem; cursor: pointer; }
        .contact-name { font-weight: bold; font-size: 1rem; }

        /* Messages */
        .messages-container { flex: 1; padding: 20px 60px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 65%; padding: 6px 7px 8px 9px; border-radius: 7.5px; font-size: 0.9rem; position: relative; box-shadow: 0 1px 0.5px rgba(11,20,26,0.13); word-wrap: break-word; }
        .message.incoming { align-self: flex-start; background: var(--incoming-bubble); border-top-left-radius: 0; }
        .message.outgoing { align-self: flex-end; background: var(--outgoing-bubble); border-top-right-radius: 0; }
        .msg-meta { display: flex; justify-content: flex-end; align-items: center; margin-top: 2px; margin-left: 10px; float: right; gap: 4px; font-size: 0.65rem; color: #8696a0; }

        /* Input Footer */
        .chat-footer {
            min-height: 62px; background: var(--header-bg); padding: 5px 16px; display: flex;
            align-items: center; gap: 15px; z-index: 10;
        }
        .input-box { flex: 1; background: #fff; border-radius: 8px; padding: 9px 12px; border: 1px solid #fff; }
        .input-box input { width: 100%; border: none; outline: none; }
        .send-icon { color: #54656f; font-size: 1.5rem; cursor: pointer; opacity: 0.5; }
        .send-icon.active { color: var(--primary-green); opacity: 1; cursor: pointer; }

        /* Empty State */
        .empty-state {
            flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #f0f2f5; border-bottom: 6px solid #25d366; text-align: center;
        }

        /* Mobile Responsive */
        @media (max-width: 900px) {
            .app-container { height: 100vh; width: 100vw; margin-top: 0; }
            .sidebar { width: 100%; max-width: none; }
            .chat-area { display: none; width: 100%; position: absolute; top: 0; left: 0; height: 100%; z-index: 20; }
            .app-container.chat-active .sidebar { display: none; }
            .app-container.chat-active .chat-area { display: flex; }
            .back-btn { display: block; }
            .messages-container { padding: 10px 15px; }
        }
    </style>
</head>
<body>

<div class="app-container">

    <!-- 1. Auth Screen -->
    <div id="authScreen" class="screen active">
        <div class="auth-wrapper">
            <div class="auth-box" id="loginBox">
                <h2>Zuber Login</h2>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter email">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="loginPass" placeholder="Enter password">
                </div>
                <button class="btn-auth" id="loginBtn">Log In</button>
                <div class="toggle-link" id="goToSignup">Create new account</div>
            </div>

            <div class="auth-box" id="signupBox" style="display:none;">
                <h2>Zuber Signup</h2>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" placeholder="Enter email">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="signupPass" placeholder="Create password">
                </div>
                <button class="btn-auth" id="signupBtn">Sign Up</button>
                <div class="toggle-link" id="goToLogin">Already have an account?</div>
            </div>
        </div>
    </div>

    <!-- 2. Username Setup Screen -->
    <div id="setupScreen" class="screen">
        <div class="auth-wrapper">
            <div class="auth-box">
                <h2>Welcome</h2>
                <p style="margin-bottom: 20px; color: #666;">Choose a unique username to start chatting.</p>
                <input type="text" id="usernameInput" placeholder="Enter username (e.g. rahul)" style="width:100%; padding:10px; margin-bottom:10px;">
                <button class="btn-auth" id="saveUsernameBtn">Start Chatting</button>
            </div>
        </div>
    </div>

    <!-- 3. Main Chat App -->
    <div id="appScreen" class="screen">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="header">
                <img src="" alt="Me" class="user-avatar" id="myAvatar">
                <div class="header-icons">
                    <button class="icon-btn" id="toggleAddContactBtn"><i class="ri-user-add-line"></i></button>
                    <button class="icon-btn" id="logoutBtn"><i class="ri-logout-box-r-line"></i></button>
                </div>
            </div>

            <!-- Add Contact Input -->
            <div class="add-contact-form" id="addContactForm">
                <input type="text" id="addContactInput" placeholder="Enter username to add...">
            </div>

            <div class="chat-list" id="chatList">
                <!-- Contacts load here -->
            </div>
        </aside>

        <!-- Chat Area -->
        <main class="chat-area" id="chatArea">
            <div class="empty-state" id="emptyState">
                <i class="ri-chat-smile-2-line" style="font-size: 4rem; color: #8ba0a6;"></i>
                <h2 style="margin-top: 20px;">Zuber Web</h2>
                <p>Send and receive messages without keeping your phone online.</p>
            </div>

            <div style="display: none; flex-direction: column; height: 100%;" id="activeChatView">
                <header class="chat-area-header">
                    <i class="ri-arrow-left-line back-btn" id="backBtn"></i>
                    <img src="" alt="User" class="user-avatar" id="currentChatAvatar" style="margin-right: 10px;">
                    <div>
                        <div class="contact-name" id="currentChatName">User Name</div>
                        <div style="font-size: 0.75rem; color: #667781;">online</div>
                    </div>
                </header>

                <div class="messages-container" id="messagesContainer"></div>

                <footer class="chat-footer">
                    <div class="input-box">
                        <input type="text" id="messageInput" placeholder="Type a message">
                    </div>
                    <i class="ri-send-plane-fill send-icon" id="sendBtn"></i>
                </footer>
            </div>
        </main>
    </div>

</div>

<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, onValue, push, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyChKPlzj9uVm3KBi4iPOz8xQHtC6v0Lt4E",
        authDomain: "krp-bank.firebaseapp.com",
        databaseURL: "https://krp-bank-default-rtdb.firebaseio.com",
        projectId: "krp-bank",
        storageBucket: "krp-bank.firebasestorage.app",
        messagingSenderId: "911407082396",
        appId: "1:911407082396:web:c5af104a844e2697797659",
        measurementId: "G-R0J2TLLC3T"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // --- DOM Elements ---
    const authScreen = document.getElementById('authScreen');
    const setupScreen = document.getElementById('setupScreen');
    const appScreen = document.getElementById('appScreen');
    
    // Auth Forms
    const loginBox = document.getElementById('loginBox');
    const signupBox = document.getElementById('signupBox');
    const goToSignup = document.getElementById('goToSignup');
    const goToLogin = document.getElementById('goToLogin');
    
    // Chat Elements
    const chatListEl = document.getElementById('chatList');
    const emptyStateEl = document.getElementById('emptyState');
    const activeChatViewEl = document.getElementById('activeChatView');
    const messagesContainerEl = document.getElementById('messagesContainer');
    const currentChatNameEl = document.getElementById('currentChatName');
    const currentChatAvatarEl = document.getElementById('currentChatAvatar');
    const messageInputEl = document.getElementById('messageInput');
    const sendBtnEl = document.getElementById('sendBtn');
    const addContactForm = document.getElementById('addContactForm');
    const addContactInput = document.getElementById('addContactInput');
    const myAvatarEl = document.getElementById('myAvatar');
    const appContainerEl = document.getElementById('appContainer');

    // --- State ---
    let currentUser = null;
    let currentUsername = null;
    let currentChatId = null; // The ID of the active conversation
    let activeContactUid = null; // The UID of the person we are talking to

    // --- Auth Logic ---

    goToSignup.onclick = () => { loginBox.style.display = 'none'; signupBox.style.display = 'block'; };
    goToLogin.onclick = () => { signupBox.style.display = 'none'; loginBox.style.display = 'block'; };

    document.getElementById('signupBtn').addEventListener('click', () => {
        const email = document.getElementById('signupEmail').value;
        const pass = document.getElementById('signupPass').value;
        if(!email || !pass) return alert("Please fill all fields");
        createUserWithEmailAndPassword(auth, email, pass)
            .catch((error) => alert(error.message));
    });

    document.getElementById('loginBtn').addEventListener('click', () => {
        const email = document.getElementById('loginEmail').value;
        const pass = document.getElementById('loginPass').value;
        signInWithEmailAndPassword(auth, email, pass)
            .catch((error) => alert(error.message));
    });

    document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            myAvatarEl.src = `https://ui-avatars.com/api/?name=${user.email}&background=random`;
            checkUsername(user.uid);
        } else {
            showScreen('authScreen');
            currentUser = null;
        }
    });

    function checkUsername(uid) {
        get(ref(db, 'users/' + uid)).then((snapshot) => {
            if (snapshot.exists()) {
                currentUsername = snapshot.val().username;
                showScreen('appScreen');
                loadContacts();
            } else {
                showScreen('setupScreen');
            }
        });
    }

    document.getElementById('saveUsernameBtn').addEventListener('click', () => {
        const username = document.getElementById('usernameInput').value.trim();
        if(!username) return alert("Username required");

        // Check if username taken
        get(ref(db, 'usernames/' + username)).then((snap) => {
            if (snap.exists()) {
                alert("Username already taken!");
            } else {
                // Save username mapping and user data
                set(ref(db, 'usernames/' + username), currentUser.uid);
                set(ref(db, 'users/' + currentUser.uid), {
                    username: username,
                    email: currentUser.email,
                    uid: currentUser.uid
                }).then(() => {
                    currentUsername = username;
                    showScreen('appScreen');
                    loadContacts();
                });
            }
        });
    });

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // --- Add Contact Logic ---
    
    document.getElementById('toggleAddContactBtn').addEventListener('click', () => {
        addContactForm.classList.toggle('active');
        if(addContactForm.classList.contains('active')) addContactInput.focus();
    });

    addContactInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const searchName = addContactInput.value.trim().toLowerCase();
            if(!searchName) return;

            // 1. Search in usernames node
            get(ref(db, 'usernames/' + searchName)).then((snapshot) => {
                if (snapshot.exists()) {
                    const friendUid = snapshot.val();
                    if (friendUid === currentUser.uid) {
                        alert("You can't add yourself!");
                        return;
                    }
                    
                    // 2. Add to my contacts list
                    set(ref(db, `users/${currentUser.uid}/contacts/${friendUid}`), {
                        username: searchName,
                        timestamp: Date.now()
                    }).then(() => {
                        addContactInput.value = '';
                        addContactForm.classList.remove('active');
                        alert("Contact Added!");
                    });

                } else {
                    alert("User not found!");
                }
            });
        }
    });

    // --- Contacts & Chat Logic ---

    function loadContacts() {
        const contactsRef = ref(db, `users/${currentUser.uid}/contacts`);
        onValue(contactsRef, (snapshot) => {
            chatListEl.innerHTML = "";
            const contacts = [];
            snapshot.forEach((child) => {
                contacts.push({ uid: child.key, ...child.val() });
            });
            // Sort by timestamp
            contacts.sort((a, b) => b.timestamp - a.timestamp);

            if(contacts.length === 0) {
                chatListEl.innerHTML = `<div style="padding:20px; text-align:center; color:#888;">No contacts added. Click + to add.</div>`;
            }

            contacts.forEach(contact => {
                const div = document.createElement('div');
                div.className = 'chat-item';
                div.onclick = () => openChat(contact.uid, contact.username);
                div.innerHTML = `
                    <img src="https://ui-avatars.com/api/?name=${contact.username}&background=random">
                    <div class="chat-info">
                        <div class="chat-name">${contact.username}</div>
                        <div class="chat-preview">Tap to chat</div>
                    </div>
                `;
                chatListEl.appendChild(div);
            });
        });
    }

    function openChat(friendUid, friendName) {
        activeContactUid = friendUid;
        // Create unique Chat ID: sort the two UIDs and join them
        currentChatId = [currentUser.uid, friendUid].sort().join('_');

        // UI Updates
        emptyStateEl.style.display = 'none';
        activeChatViewEl.style.display = 'flex';
        currentChatNameEl.innerText = friendName;
        currentChatAvatarEl.src = `https://ui-avatars.com/api/?name=${friendName}&background=random`;
        
        // Mobile View Switch
        appContainerEl.classList.add('chat-active');

        loadMessages();
    }

    function loadMessages() {
        if(!currentChatId) return;
        const messagesRef = ref(db, `chats/${currentChatId}`);
        onValue(messagesRef, (snapshot) => {
            messagesContainerEl.innerHTML = "";
            const msgs = [];
            snapshot.forEach((child) => msgs.push(child.val()));
            msgs.sort((a, b) => a.timestamp - b.timestamp);

            msgs.forEach(msg => {
                const div = document.createElement('div');
                const isMine = msg.sender === currentUser.uid;
                div.className = `message ${isMine ? 'outgoing' : 'incoming'}`;
                
                const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const tick = isMine ? '<i class="ri-check-double-line"></i>' : '';

                div.innerHTML = `
                    <div class="msg-content">${msg.text}</div>
                    <div class="msg-meta">
                        <span>${time}</span> ${tick}
                    </div>
                `;
                messagesContainerEl.appendChild(div);
            });
            messagesContainerEl.scrollTop = messagesContainerEl.scrollHeight;
        });
    }

    // Send Message
    messageInputEl.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
    
    sendBtnEl.addEventListener('click', sendMessage);

    function sendMessage() {
        const text = messageInputEl.value.trim();
        if(!text || !currentChatId) return;

        push(ref(db, `chats/${currentChatId}`), {
            sender: currentUser.uid,
            text: text,
            timestamp: Date.now()
        }).then(() => {
            messageInputEl.value = '';
        });
    }

    // Mobile Back Button
    document.getElementById('backBtn').addEventListener('click', () => {
        appContainerEl.classList.remove('chat-active');
    });

</script>
</body>
</html>
