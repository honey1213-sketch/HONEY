<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zuber Pro - Secure Chat</title>
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        /* --- Premium Global Variables --- */
        :root {
            --bg-color: #d1d7db;
            --sidebar-bg: #ffffff;
            --chat-bg: #efeae2;
            --primary-green: #00a884;
            --outgoing-bubble: #d9fdd3;
            --incoming-bubble: #ffffff;
            --text-primary: #111b21;
            --text-secondary: #667781;
            --border-color: #e9edef;
            --header-bg: #f0f2f5;
            --blue-tick: #34b7f1;
            --shadow: 0 17px 50px 0 rgba(11,20,26,.19), 0 12px 15px 0 rgba(11,20,26,.24);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif; }
        
        body { background-color: var(--bg-color); height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }

        /* --- App Container --- */
        .app-wrapper {
            width: 100%; height: 100%; max-width: 1600px; background: #fff; display: flex;
            position: relative; overflow: hidden; box-shadow: var(--shadow);
        }

        /* --- Screens & Animations --- */
        .screen { display: none; width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s ease; }
        .screen.active { display: flex; opacity: 1; }
        
        /* 1. Splash Screen */
        #splashScreen {
            background-color: #111b21; color: white; flex-direction: column;
            justify-content: center; align-items: center; z-index: 999;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1);
            border-top: 5px solid var(--primary-green); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .splash-text { font-size: 1.2rem; letter-spacing: 1px; font-weight: 300; }

        /* 2. Auth Screen */
        #authScreen {
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            background-size: cover; background-position: center;
            justify-content: center; align-items: center;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 4px; width: 100%; max-width: 400px;
            text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .login-logo { font-family: 'Segoe UI', sans-serif; color: var(--primary-green); font-size: 2rem; margin-bottom: 10px; font-weight: bold; }
        .input-field {
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            margin-bottom: 15px; border-radius: 4px; outline: none; font-size: 0.9rem;
        }
        .btn-primary {
            width: 100%; padding: 12px; background: var(--primary-green); color: white;
            border: none; font-weight: 600; cursor: pointer; font-size: 1rem;
        }
        .btn-link { margin-top: 15px; font-size: 0.9rem; cursor: pointer; color: var(--primary-green); }

        /* --- Main App Layout --- */
        .sidebar {
            width: 30%; min-width: 320px; max-width: 450px; border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; background: var(--sidebar-bg);
        }
        
        /* Header */
        .header {
            height: 60px; background-color: var(--header-bg); padding: 10px 16px; display: flex;
            align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color);
        }
        .avatar-container { position: relative; cursor: pointer; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .camera-icon {
            position: absolute; bottom: 0; right: 0; background: var(--primary-green);
            color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px;
            display: flex; align-items: center; justify-content: center; border: 2px solid white;
        }
        .icon-btn { cursor: pointer; font-size: 1.2rem; color: #54656f; background: none; border: none; }

        /* Add Contact Form */
        .add-contact-form {
            padding: 10px 15px; background: #fff; border-bottom: 1px solid #e9edef; display: none;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .search-input {
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; outline: none; background: #f0f2f5;
        }

        /* Chat List */
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item {
            display: flex; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f2f5;
            transition: background 0.2s;
        }
        .chat-item:hover { background-color: #f5f6f6; }
        .chat-item.active { background-color: #f0f2f5; }
        .chat-item img { width: 49px; height: 49px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
        .chat-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .chat-header { display: flex; justify-content: space-between; align-items: center; }
        .chat-name { font-size: 1.05rem; color: var(--text-primary); font-weight: 400; display: flex; align-items: center; gap: 4px; }
        .verified-badge { color: var(--blue-tick); font-size: 1rem; }
        .chat-time { font-size: 0.75rem; color: var(--text-secondary); }
        .chat-preview { font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Chat Area --- */
        .chat-area {
            flex: 1; display: flex; flex-direction: column;
            background-color: var(--chat-bg);
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            position: relative;
        }

        /* Chat Header */
        .chat-area-header {
            height: 60px; background: var(--header-bg); padding: 0 16px; display: flex;
            align-items: center; border-bottom: 1px solid var(--border-color); z-index: 10;
        }
        .back-btn { display: none; margin-right: 10px; font-size: 1.5rem; cursor: pointer; color: #54656f; }
        .chat-info-header { display: flex; flex-direction: column; }
        .chat-header-name { font-weight: 500; font-size: 1rem; display: flex; align-items: center; gap: 5px; }

        /* Messages */
        .messages-container { flex: 1; padding: 20px 60px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .message { max-width: 65%; padding: 6px 7px 8px 9px; border-radius: 7.5px; font-size: 0.9rem; position: relative; box-shadow: 0 1px 0.5px rgba(11,20,26,0.13); word-wrap: break-word; }
        .message.incoming { align-self: flex-start; background: var(--incoming-bubble); border-top-left-radius: 0; }
        .message.outgoing { align-self: flex-end; background: var(--outgoing-bubble); border-top-right-radius: 0; }
        .msg-meta { display: flex; justify-content: flex-end; align-items: center; margin-top: 2px; margin-left: 10px; float: right; gap: 4px; font-size: 0.65rem; color: #8696a0; }

        /* Input Footer */
        .chat-footer {
            min-height: 62px; background: var(--header-bg); padding: 5px 16px; display: flex;
            align-items: center; gap: 15px; z-index: 10;
        }
        .input-box { flex: 1; background: #fff; border-radius: 8px; padding: 9px 12px; border: 1px solid #fff; }
        .input-box input { width: 100%; border: none; outline: none; font-size: 0.95rem; }
        .send-icon { color: #54656f; font-size: 1.5rem; cursor: pointer; opacity: 0.5; }
        .send-icon.active { color: var(--primary-green); opacity: 1; }

        /* Empty State */
        .empty-state {
            flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #f0f2f5; border-bottom: 6px solid #25d366; text-align: center;
        }

        /* --- Settings Modal --- */
        .settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center;
        }
        .settings-content {
            background: white; width: 400px; border-radius: 8px; overflow: hidden; animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .settings-header {
            background: #f0f2f5; padding: 20px; text-align: center; border-bottom: 1px solid #ddd;
        }
        .settings-header img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px; object-fit: cover; border: 4px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .settings-list { padding: 10px 0; }
        .settings-item {
            padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s;
        }
        .settings-item:hover { background: #f9f9f9; }
        .settings-item:last-child { border-bottom: none; }
        .item-label { font-size: 1rem; color: #111b21; }
        .verified-btn { background: #111b21; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; }

        /* Mobile Responsive */
        @media (max-width: 900px) {
            .app-wrapper { height: 100vh; width: 100vw; margin-top: 0; border: none; }
            .sidebar { width: 100%; max-width: none; }
            .chat-area { display: none; width: 100%; position: absolute; top: 0; left: 0; height: 100%; z-index: 20; }
            .app-wrapper.chat-active .sidebar { display: none; }
            .app-wrapper.chat-active .chat-area { display: flex; }
            .back-btn { display: block; }
            .messages-container { padding: 10px 15px; }
        }
    </style>
</head>
<body>

<div class="app-wrapper">

    <!-- 1. Splash Screen -->
    <div id="splashScreen" class="screen active">
        <div class="spinner"></div>
        <div class="splash-text" id="splashText">Zuber Pro</div>
    </div>

    <!-- 2. Auth Screen -->
    <div id="authScreen" class="screen">
        <div class="login-card">
            <div class="login-logo">Zuber Pro</div>
            <p style="color:#666; margin-bottom:20px;">Secure and Premium Messaging</p>
            
            <div id="loginForm">
                <input type="email" id="loginEmail" class="input-field" placeholder="Email Address">
                <input type="password" id="loginPass" class="input-field" placeholder="Password">
                <button class="btn-primary" id="loginBtn">Login to Zuber</button>
                <div class="btn-link" id="goToSignup">Create new account</div>
            </div>

            <div id="signupForm" style="display:none;">
                <input type="email" id="signupEmail" class="input-field" placeholder="Email Address">
                <input type="password" id="signupPass" class="input-field" placeholder="Create Password">
                <button class="btn-primary" id="signupBtn">Get Started</button>
                <div class="btn-link" id="goToLogin">Already have an account?</div>
            </div>
        </div>
    </div>

    <!-- 3. Setup Username Screen -->
    <div id="setupScreen" class="screen" style="justify-content:center; align-items:center; background:#fff;">
        <div class="login-card">
            <h2>Setup Profile</h2>
            <p style="color:#666; margin-bottom:15px; font-size:0.9rem;">Choose a unique username to start chatting.</p>
            <input type="text" id="usernameInput" class="input-field" placeholder="e.g. zuber123">
            <button class="btn-primary" id="saveUsernameBtn">Continue</button>
        </div>
    </div>

    <!-- 4. Main App -->
    <div id="appScreen" class="screen">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="header">
                <div class="avatar-container" onclick="openSettings()">
                    <img src="" alt="Me" class="user-avatar" id="myAvatar">
                    <div class="camera-icon"><i class="ri-camera-fill"></i></div>
                    <input type="file" id="profilePicInput" style="display:none;" accept="image/*">
                </div>
                <div class="header-icons" style="display:flex; gap:20px;">
                    <button class="icon-btn" id="toggleAddContactBtn"><i class="ri-user-add-line"></i></button>
                    <button class="icon-btn" id="logoutBtn"><i class="ri-more-2-fill"></i></button>
                </div>
            </div>

            <!-- Add Contact Input -->
            <div class="add-contact-form" id="addContactForm">
                <input type="text" id="addContactInput" class="search-input" placeholder="Search exact username to add...">
            </div>

            <div class="chat-list" id="chatList">
                <!-- Dynamic Contacts -->
            </div>
        </aside>

        <!-- Chat Area -->
        <main class="chat-area" id="chatArea">
            <div class="empty-state" id="emptyState">
                <div style="width: 250px; opacity: 0.6; margin-bottom: 20px;">
                   <!-- WhatsApp Logo Placeholder -->
                   <svg viewBox="0 0 24 24" fill="#25d366" style="width:100%; height:100%;"><path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.711 2.598 2.664-.698c.93.509 1.799.744 2.796.744 3.182 0 5.768-2.587 5.768-5.767-0.001-3.182-2.586-5.768-5.768-5.768zm9.969 5.766c0 5.508-4.482 9.99-9.99 9.99-1.69 0-3.285-.427-4.679-1.172l-5.331 1.4 1.428-5.193c-.862-1.474-1.358-3.187-1.358-5.025 0-5.508 4.482-9.99 9.99-9.99 5.507 0 9.989 4.482 9.94 9.99z"/></svg>
                </div>
                <h2 style="font-weight:300; color:#41525d;">Zuber Web</h2>
                <p style="color:#667781; font-size:0.9rem; margin-top:10px;">Send and receive messages securely.</p>
            </div>

            <div style="display: none; flex-direction: column; height: 100%;" id="activeChatView">
                <header class="chat-area-header">
                    <i class="ri-arrow-left-line back-btn" id="backBtn"></i>
                    <img src="" alt="User" class="user-avatar" id="currentChatAvatar" style="margin-right: 10px;">
                    <div class="chat-info-header">
                        <div class="chat-header-name" id="currentChatName">User Name</div>
                        <div style="font-size: 0.75rem; color: #667781;">online</div>
                    </div>
                </header>

                <div class="messages-container" id="messagesContainer"></div>

                <footer class="chat-footer">
                    <div class="input-box">
                        <input type="text" id="messageInput" placeholder="Type a message">
                    </div>
                    <i class="ri-send-plane-fill send-icon" id="sendBtn"></i>
                </footer>
            </div>
        </main>
    </div>

</div>

<!-- Settings Modal -->
<div id="settingsModal" class="settings-modal">
    <div class="settings-content">
        <div class="settings-header" onclick="document.getElementById('settingsModal').style.display='none'">
            <img src="" id="settingsProfilePic" alt="Profile">
            <h3 id="settingsName">Name</h3>
            <p id="settingsStatus">Online</p>
        </div>
        <div class="settings-list">
            <div class="settings-item">
                <span class="item-label">Account</span>
                <i class="ri-arrow-right-s-line" style="color:#888;"></i>
            </div>
            <div class="settings-item">
                <span class="item-label">Privacy</span>
                <i class="ri-arrow-right-s-line" style="color:#888;"></i>
            </div>
            <div class="settings-item" id="blueTickSection">
                <div>
                    <div class="item-label" style="font-weight:bold;">Request Verification</div>
                    <div style="font-size:0.8rem; color:#666;">Get the Blue Tick (✅)</div>
                </div>
                <button class="verified-btn" id="requestBlueTickBtn">REQUEST</button>
            </div>
            <div class="settings-item" style="justify-content:center; color:#ed4956; font-weight:bold;" id="logoutRealBtn">
                Log Out
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, onValue, push, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyChKPlzj9uVm3KBi4iPOz8xQHtC6v0Lt4E",
        authDomain: "krp-bank.firebaseapp.com",
        databaseURL: "https://krp-bank-default-rtdb.firebaseio.com",
        projectId: "krp-bank",
        storageBucket: "krp-bank.firebasestorage.app",
        messagingSenderId: "911407082396",
        appId: "1:911407082396:web:c5af104a844e2697797659",
        measurementId: "G-R0J2TLLC3T"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // --- DOM Elements ---
    const splashScreen = document.getElementById('splashScreen');
    const splashText = document.getElementById('splashText');
    const authScreen = document.getElementById('authScreen');
    const setupScreen = document.getElementById('setupScreen');
    const appScreen = document.getElementById('appScreen');
    const settingsModal = document.getElementById('settingsModal');

    // --- Splash Screen Logic ---
    function showSplash(text, callback) {
        splashText.innerText = text;
        splashScreen.classList.add('active');
        authScreen.classList.remove('active');
        appScreen.classList.remove('active');
        setupScreen.classList.remove('active');
        
        setTimeout(() => {
            splashScreen.classList.remove('active');
            if(callback) callback();
        }, 2000);
    }

    // Initial Load
    showSplash("Zuber Pro");

    // --- Auth Logic ---
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    
    document.getElementById('goToSignup').onclick = () => { loginForm.style.display='none'; signupForm.style.display='block'; };
    document.getElementById('goToLogin').onclick = () => { signupForm.style.display='none'; loginForm.style.display='block'; };

    document.getElementById('signupBtn').onclick = () => {
        const e = document.getElementById('signupEmail').value;
        const p = document.getElementById('signupPass').value;
        createUserWithEmailAndPassword(auth, e, p).catch(alert);
    };

    document.getElementById('loginBtn').onclick = () => {
        const e = document.getElementById('loginEmail').value;
        const p = document.getElementById('loginPass').value;
        signInWithEmailAndPassword(auth, e, p).catch(alert);
    };

    document.getElementById('logoutRealBtn').onclick = () => {
        signOut(auth).then(() => {
            settingsModal.style.display = 'none';
            window.location.reload();
        });
    };

    let currentUser = null;
    let currentUsername = null;

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            checkUsername(user.uid);
        } else {
            authScreen.classList.add('active');
        }
    });

    function checkUsername(uid) {
        get(ref(db, 'users/' + uid)).then((snap) => {
            if (snap.exists()) {
                currentUsername = snap.val().username;
                showSplash("Loading your information...", () => {
                    appScreen.classList.add('active');
                    initApp();
                });
            } else {
                setupScreen.classList.add('active');
            }
        });
    }

    document.getElementById('saveUsernameBtn').onclick = () => {
        const uname = document.getElementById('usernameInput').value.trim();
        if(uname.length < 3) return alert("Username too short");
        
        get(ref(db, 'usernames/' + uname)).then((s) => {
            if(s.exists()) return alert("Username taken");
            set(ref(db, 'usernames/' + uname), uid);
            set(ref(db, 'users/' + uid), {
                username: uname, email: currentUser.email, uid: uid, verified: false, profilePic: null
            }).then(() => {
                currentUsername = uname;
                showSplash("Loading your information...", () => {
                    appScreen.classList.add('active');
                    initApp();
                });
            });
        });
    };

    // --- App Initialization ---
    function initApp() {
        loadContacts();
        // Check verification status
        get(ref(db, 'users/'+currentUser.uid)).then(snap => {
            const data = snap.val();
            document.getElementById('settingsName').innerText = data.username;
            document.getElementById('settingsStatus').innerText = data.verified ? "Verified Account" : "Standard Account";
            if(data.profilePic) {
                document.getElementById('myAvatar').src = data.profilePic;
                document.getElementById('settingsProfilePic').src = data.profilePic;
            } else {
                const def = `https://ui-avatars.com/api/?name=${data.username}&background=random`;
                document.getElementById('myAvatar').src = def;
                document.getElementById('settingsProfilePic').src = def;
            }
            
            // Hide blue tick button if already verified
            if(data.verified) {
                document.getElementById('blueTickSection').style.display = 'none';
            }
        });

        // Settings Trigger
        window.openSettings = () => {
            settingsModal.style.display = 'flex';
        };
    }

    // --- Blue Tick Logic (Premium) ---
    document.getElementById('requestBlueTickBtn').onclick = () => {
        const btn = document.getElementById('requestBlueTickBtn');
        btn.innerText = "Processing...";
        btn.style.opacity = "0.7";
        
        const email = currentUser.email;
        
        // 1. Save Request to DB
        set(ref(db, 'admin/requests/' + currentUser.uid), {
            email: email,
            username: currentUsername,
            status: 'pending',
            timestamp: Date.now()
        }).then(() => {
            
            // 2. SPECIFIC LOGIC FOR USER REQUEST (Auto-approve for demo)
            if (email.toLowerCase() === 'honey232124@gmail.com') {
                setTimeout(() => {
                    update(ref(db, 'users/' + currentUser.uid), { verified: true });
                    alert("Congratulations! Your account is now VERIFIED (✅)");
                    settingsModal.style.display = 'none';
                    initApp(); // Refresh settings view
                    loadContacts(); // Refresh list to show tick
                }, 1500);
            } else {
                // For others, just say sent
                setTimeout(() => {
                    alert("Verification request sent to admin (Zuber Team).");
                    settingsModal.style.display = 'none';
                }, 1500);
            }
        });
    };

    // --- Profile Picture Logic ---
    document.querySelector('.avatar-container').onclick = (e) => {
        if(e.target.className.includes('camera-icon')) {
            document.getElementById('profilePicInput').click();
        } else {
            openSettings();
        }
    };

    document.getElementById('profilePicInput').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;

        try {
            const storageRef = sRef(storage, 'profile_pics/' + currentUser.uid);
            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);
            
            update(ref(db, 'users/' + currentUser.uid), { profilePic: url });
            alert("Profile Picture Updated!");
            initApp();
        } catch(err) {
            console.error(err);
            alert("Update failed (Check Storage Rules).");
        }
    };

    // --- Chat Logic (Contacts & Messaging) ---
    const addContactForm = document.getElementById('addContactForm');
    document.getElementById('toggleAddContactBtn').onclick = () => {
        addContactForm.style.display = addContactForm.style.display === 'none' ? 'block' : 'none';
        if(addContactForm.style.display === 'block') document.getElementById('addContactInput').focus();
    };

    document.getElementById('addContactInput').onkeypress = (e) => {
        if(e.key === 'Enter') {
            const u = document.getElementById('addContactInput').value.trim().toLowerCase();
            if(!u) return;

            get(ref(db, 'usernames/' + u)).then(snap => {
                if(snap.exists()) {
                    const fid = snap.val();
                    if(fid === currentUser.uid) return alert("Cannot add yourself");
                    set(ref(db, 'users/'+currentUser.uid+'/contacts/'+fid), { username: u, timestamp: Date.now() })
                        .then(() => {
                            document.getElementById('addContactInput').value = '';
                            addContactForm.style.display = 'none';
                        });
                } else {
                    alert("User not found");
                }
            });
        }
    };

    function loadContacts() {
        const list = document.getElementById('chatList');
        onValue(ref(db, 'users/'+currentUser.uid+'/contacts'), snap => {
            list.innerHTML = "";
            const c = [];
            snap.forEach(child => c.push({uid: child.key, ...child.val()}));
            c.sort((a,b) => b.timestamp - a.timestamp);

            c.forEach(contact => {
                const div = document.createElement('div');
                div.className = 'chat-item';
                div.onclick = () => openChat(contact.uid, contact.username);
                
                // Check if contact is verified (Mock check by fetching user data)
                get(ref(db, 'users/'+contact.uid)).then(uSnap => {
                    const isVerified = uSnap.exists() && uSnap.val().verified;
                    const tick = isVerified ? '<i class="ri-check-double-fill verified-badge"></i>' : '';
                    
                    div.innerHTML = `
                        <img src="https://ui-avatars.com/api/?name=${contact.username}&background=random">
                        <div class="chat-info">
                            <div class="chat-header">
                                <div class="chat-name">${contact.username} ${tick}</div>
                                <span class="chat-time"></span>
                            </div>
                            <div class="chat-preview">Tap to chat</div>
                        </div>
                    `;
                });
                list.appendChild(div);
            });
        });
    }

    let currentChatId = null;
    function openChat(fUid, fName) {
        currentChatId = [currentUser.uid, fUid].sort().join('_');
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('activeChatView').style.display = 'flex';
        document.getElementById('currentChatName').innerHTML = fName;
        document.getElementById('currentChatAvatar').src = `https://ui-avatars.com/api/?name=${fName}&background=random`;
        
        document.getElementById('appWrapper').classList.add('chat-active'); // Mobile view
        loadMessages();
    }

    function loadMessages() {
        onValue(ref(db, 'chats/'+currentChatId), snap => {
            const con = document.getElementById('messagesContainer');
            con.innerHTML = "";
            const m = [];
            snap.forEach(child => m.push(child.val()));
            m.sort((a,b) => a.timestamp - b.timestamp);

            m.forEach(msg => {
                const div = document.createElement('div');
                div.className = `message ${msg.sender === currentUser.uid ? 'outgoing' : 'incoming'}`;
                div.innerHTML = `
                    <div class="msg-content">${msg.text}</div>
                    <div class="msg-meta">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                `;
                con.appendChild(div);
            });
            con.scrollTop = con.scrollHeight;
        });
    }

    document.getElementById('sendBtn').onclick = sendMessage;
    document.getElementById('messageInput').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };

    function sendMessage() {
        const txt = document.getElementById('messageInput').value.trim();
        if(!txt || !currentChatId) return;
        push(ref(db, 'chats/'+currentChatId), {
            sender: currentUser.uid,
            text: txt,
            timestamp: Date.now()
        });
        document.getElementById('messageInput').value = "";
    }

    document.getElementById('backBtn').onclick = () => {
        document.getElementById('appWrapper').classList.remove('chat-active');
    };

</script>
</body>
</html>
